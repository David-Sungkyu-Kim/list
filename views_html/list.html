<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Toy project</title>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
        integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
  <link rel="stylesheet" href="../resources/css/style.css">
</head>
<body>

<div class="wrapper clearfix">

  <!-- wrap_contents -->
  <div class="wrap_contents">

    <div class="area_left _leftNavi">
      <ul>
        <li class="active"><a href="#">1</a></li>
        <li><a href="#">2</a></li>
        <li><a href="#">3</a></li>
      </ul>
    </div>

    <div class="area_title">
      <h1>List <i class="fas fa-archive"></i></h1>
      <span>- Stats List</span>
    </div>

    <div class="area_contents">

      <div class="row">
        <div class="col">
          <div class="row card_section section_contents section_block" style="height: 838px;overflow: hidden">
            <div class="col-2">
              <div class="area_channel_list">
                <div class="title_sub">Channel List</div>
                <div class="scroll">
                  <ul id="channelList" class="box_channel_list">

                  </ul>
                </div>

              </div>

            </div>

            <div class="col-3">
              <div class="area_block_list">
                <div class="title_sub">Block List</div>
                <div class="scroll">
                  <ul id="blockList" class="box_block_list">

                  </ul>
                </div>

              </div>

            </div>

            <div class="col-7">
              <div class="title_sub">Transaction List</div>
              <div class="area_transaction_list scroll">
                <ul id="transactionList">

                </ul>
              </div>
            </div>
          </div>

        </div>

      </div>

    </div>

  </div>
  <!-- // wrap_contents -->

  <!-- wrap_footer -->
  <div class="wrap_footer">
    footer
  </div>
  <!-- // wrap_footer -->

</div>

<div class="popup_dim popup_dim_transparent _loader">
  <div class="box_loader">
    <div class="loader">Loading...</div>
  </div>
</div>

<script src="../resources/js/ui.common.js"></script>
<script src="../resources/js/ui.init.js"></script>
<script>

  const blockList = (function () {
    const url = "../resources/json/block.json";
    // const url = '${pageContext.request.contextPath}/json/block_graph.gbj';

    let oOriginData = {};
    let oNewData = null;
    let insertData = {};
    let nClickIndex = 0;
    let nChannelIndex = 0;
    let timer = null;
    let prevIndex = 0;
    let bFirst = null;
    const btnMore = document.createElement('p');
    const btnMoreText = document.createTextNode('Load more');
    btnMore.appendChild(btnMoreText);
    btnMore.classList.add('btn','btn-outline-orange','btn-sm', 'btn_more');

    initBlockList(url);

    // Fetch
    function initBlockList(url) {
      fetch(url).then(function (response) {
        // console.log('loading start...');
        if (response.ok) {
          return response.json();
        } else {
          return Promise.reject({
            status: response.status,
            statusText: response.statusText
          });
        }
      }).then(function (responseData) {
        bFirst = true;
        oOriginData = responseData;
        if (localStorage.originData !== undefined) {
          localStorage.removeItem('originData');
        }
        localStorage.setItem('originData', JSON.stringify(responseData));
        makeBlockchainList(oOriginData, 0, 0);

        for (let i = 0; i < responseData.length; i++) {
          if (responseData[i].chname !== '' && responseData[i].chname !== undefined) {
            document.querySelectorAll('.area_channel_list li')[0].classList.add('active');
          }
          if (responseData[i].blks.length > 0 && responseData[i].blks !== undefined) {
            document.querySelectorAll('.area_block_list li')[0].classList.add('active');
          }
          document.querySelector('._loader').style.display = 'none';
        }
        // console.log('loading end...');
      }).catch(function (error) {
        console.error(error);
      });
    }

    // List render
    /**
     * @param data
     * @param channelIndex
     * @param blockIndex
     */
    function makeBlockchainList(data, channelIndex, blockIndex) {
      document.getElementById("transactionList").innerHTML = '';
      document.getElementById("channelList").innerHTML = '';

      makeChannelList(data, channelIndex);
      makeBlockList(data[channelIndex].blks, channelIndex, blockIndex);
      makeTxInfo(data[channelIndex].blks, blockIndex);

    }

    /**
     * channelList 템플릿 함수
     * @param data
     * @param channelIndex : active된 channelList li의 index
     * 받은 채널 데이터로 리스트 생성
     */
    function makeChannelList(data, channelIndex) {
      let html = document.getElementById("chListTemplate").innerHTML;
      let resultHTML = '';

      for (let i = 0; i < data.length; i++) {
        if (data[i].chname !== '' && data[i].chname !== undefined) {
          resultHTML = html.replace("{channelName}", data[i].chname)
            .replace("{channelName}", data[i].chname);
          document.getElementById("channelList").innerHTML += resultHTML;

          if (i === data.length - 1) {
            document.querySelectorAll('.area_channel_list li')[channelIndex].classList.add('active');
          }

        } else {
          // empty 처리
          document.getElementById("channelList").innerHTML = document.getElementById('noDataTemplate').innerHTML;
        }
      }

    }

    /**
     * blockList 템플릿 함수
     * @param blockData
     * @param channelIndex : channelIndex
     *
     */
    function makeBlockList(blockData, channelIndex, blockIndex) {
      let resultHTML = '';

      nChannelIndex = channelIndex;
      clearTimeout(timer);

      insertData = JSON.parse(localStorage.getItem('originData'));
      insertData[nChannelIndex].blks = blockData.slice(0, nClickIndex + 11);
      oNewData = insertData;

      // 10개 체크
      if (blockData.length > 0 && insertData[nChannelIndex].blks.length <= 12 + nClickIndex) {

        if (document.querySelector('.txt_no_data')) {
          document.getElementById("blockList").innerHTML = '';
        }

        // 처음 로딩 시에 리스트 생성
        if (bFirst === true) {
          blockList(insertData[nChannelIndex].blks);
          bFirst = false;
          timer = setTimeout(function () {
            document.querySelectorAll('.area_block_list li')[prevIndex].classList.add('active');
          }, 100);

        } else {
          oNewData[nChannelIndex].blks = insertData[nChannelIndex].blks.slice(0, nClickIndex + 11);
          blockList(oNewData[nChannelIndex].blks);
          timer = setTimeout(function () {
            document.querySelectorAll('.area_block_list li')[blockIndex].classList.add('active');
          }, 100);
        }

        if (insertData[nChannelIndex].blks.length < oOriginData[nChannelIndex].blks.length) {
          btnMore.appendChild(btnMoreText);
          document.querySelector(".area_block_list .scroll").appendChild(btnMore);
        } else {
          if (document.querySelector('.btn_more')) {
            document.querySelector(".area_block_list .scroll").removeChild(btnMore);
          }
        }

      } else {
        // empty 처리
        document.getElementById("blockList").innerHTML = document.getElementById('noDataTemplate').innerHTML;

        if (document.querySelector('.btn_more')) {
          document.querySelector(".area_block_list .scroll").removeChild(btnMore);
        }
      }

      function blockList(oData) {
        document.getElementById("blockList").innerHTML = '';
        oData.forEach(function (blockData) {
          resultHTML += '<li><a href="#"><i class="far fa-folder"></i><i class="far fa-folder-open"></i><div><table><tbody><tr><th>' + 'block ID :' + '</th>' + '<td>' + blockData['blockId'] + '</td></tr>';
          resultHTML += '<tr><th>' + 'Tx amount :' + '</th>' + '<td>' + blockData['tx_count'] + '</td></tr></tbody></table><div></a></li>';

        });
        document.getElementById("blockList").innerHTML += resultHTML;
      }
    }

    /**
     * txInfo
     * @param blockData
     * @param blockIndex : active된 blockList li의 index
     * blockIndex로 detail 조회
     */
    function makeTxInfo(blockData, blockIndex) {
      var html = document.getElementById("txListTemplate").innerHTML;
      var resultHTML = '';

      if (blockData.length <= blockIndex) { // click 시 가끔 active를 못찾는 버그픽스
        if (blockData.length > 0) {
          document.querySelectorAll('.area_block_list li')[prevIndex].classList.add('active');

          blockData[prevIndex].detail.forEach(function (txData) {
            resultHTML = html
              .replace("{Function}", txData.args[0])
              .replace("{Argument}", txData.args.slice(1,))
              .replace("{Datetime}", txData.datetime)
              .replace("{TxID}", txData.tx_id);

            document.getElementById("transactionList").innerHTML += resultHTML;

          });
        } else {
          // empty 처리
          document.getElementById("transactionList").innerHTML = document.getElementById('noDataTemplate').innerHTML;
        }

      } else {
        if (blockData.length > 0) {
          blockData[blockIndex].detail.forEach(function (txData) {
            resultHTML = html
              .replace("{Function}", txData.args[0])
              .replace("{Argument}", txData.args.slice(1,))
              .replace("{Datetime}", txData.datetime)
              .replace("{TxID}", txData.tx_id);

            document.getElementById("transactionList").innerHTML += resultHTML;

          });

        } else {
          // empty 처리
          document.getElementById("transactionList").innerHTML = document.getElementById('noDataTemplate').innerHTML;
        }
      }

    }

    /**
     * Load more lists
     * data : originData
     * insertData : 원 데이터를 추가할 구간만 추출하여 붙일 list 생성
     * oNewData : 첫번째 부터 현재 구간까지의 총 list
     **/
    function addList(data) {
      let resultHTML = '';
      let insertData = data;

      insertData[nChannelIndex].blks = data.slice(nClickIndex, nClickIndex + 11);
      let thisData = insertData[nChannelIndex].blks = data.slice(nClickIndex, nClickIndex + 11);
      oNewData[nChannelIndex].blks = data.slice(0, nClickIndex + 11);

      // 10개 체크
      if (thisData.length >= 11) {
        btnMore.appendChild(btnMoreText);
        document.querySelector(".area_block_list .scroll").appendChild(btnMore);

      }

      list(insertData[nChannelIndex].blks);

      function list(oData) {
        oData.forEach(function (blockData) {
          resultHTML += '<li><a href="#"><i class="far fa-folder"></i><i class="far fa-folder-open"></i><div><table><tbody><tr><th>' + 'block ID :' + '</th>' + '<td>' + blockData['blockId'] + '</td></tr>';
          resultHTML += '<tr><th>' + 'Tx amount :' + '</th>' + '<td>' + blockData['tx_count'] + '</td></tr></tbody></table><div></a></li>';
        });
      }

      document.getElementById("blockList").insertAdjacentHTML('beforeend', resultHTML);

    }

    /**
     * click event handler
     **/
    document.querySelector('.section_contents').addEventListener('click', function (event) {
      // Load more 버튼 클릭 시
      if (event.target.classList === 'btnMore' || event.target.tagName === "P") {
        bFirst = false;
        //Load more 일 때 active 유지
        prevIndex = oGbUi.nPrevIndex;
        nClickIndex += 11;
        document.querySelector(".area_block_list .scroll").removeChild(btnMore);
        addList(oOriginData[nChannelIndex].blks);

      } else {
        if (
          event.target.tagName !== 'UL' ||
          event.target.tagName !== 'TBODY'
        ) {
          /**
           * 클릭한 이벤트 타겟의 부모를 체크 후 해당 list에만 동작.
           * @param element : 객체
           * @param selector : 객체의 부모 엘리먼트
           */
          let getParents = function (elem, selector) {
            if (!Element.prototype.matches) {
              Element.prototype.matches =
                Element.prototype.matchesSelector ||
                Element.prototype.mozMatchesSelector ||
                Element.prototype.msMatchesSelector ||
                Element.prototype.oMatchesSelector ||
                Element.prototype.webkitMatchesSelector ||
                function (s) {
                  let matches = (this.document || this.ownerDocument).querySelectorAll(s),
                    i = matches.length;
                  while (--i >= 0 && matches.item(i) !== this) {
                  }
                  return i > -1;
                };
            }

            let parents = [];

            for (; elem && elem !== document; elem = elem.parentNode) {
              if (selector) {
                if (elem.matches(selector)) {
                  parents.push(elem);
                }
                continue;
              }
              parents.push(elem);
            }
            return parents;
          };

          let cparents = getParents(event.target, '.box_channel_list');
          let bparents = getParents(event.target, '.box_block_list');

          let cIdx = indexInClass(document.querySelectorAll('.box_channel_list li'));
          let idx = indexInClass(document.querySelectorAll('.box_block_list li'));

          if (cparents.length > 0) {
            if (cparents[0].classList.value === 'box_channel_list') {
              bFirst = true;
              prevIndex = 0;
              for (let i = 0; i < oNewData.length; i++) {
                if (event.target.innerText === document.querySelectorAll('#channelList li')[i].dataset.name) {
                  makeBlockchainList(oNewData, cIdx, 0, idx);
                  break;
                }
                // bFirst = true;
                makeBlockchainList(oNewData, cIdx, 0, idx);
              }
            }
          }

          if (bparents.length > 0) {
            if (bparents[0].classList.value === 'box_block_list') {
              makeBlockchainList(oNewData, cIdx, idx);
            }
          }

        }
      }
    }.bind(this));

    /**
     * blockList li.active의 index를 return하고 txList url 보냄
     * @param element
     */
    function indexInClass(element) {
      let nActiveIndex = 0;
      for (let array of element) {
        const className = array.className;
        if (className === 'active') {
          break;
        } else {
          nActiveIndex++;
        }
      }
      return nActiveIndex;
    }

  })();

</script>

<script id="blockListTemplate" type="x-template">
  <a href="#">
    <i class="far fa-folder"></i>
    <i class="far fa-folder-open"></i>
    <div>
      <table>
        <tbody>
        <tr>
          <th>block ID :</th>
          <td>{blockID}</td>
        </tr>
        <tr>
          <th>Tx amount :</th>
          <td>{txAmount}</td>
        </tr>
        </tbody>
      </table>
    </div>
  </a>
</script>

<script id="txListTemplate" type="x-template">
  <li>
    <table class="table table-bordered table-striped">
      <colgroup>
        <col style="width: 30%;">
      </colgroup>
      <tbody>
      <tr>
        <th>Function</th>
        <td>{Function}</td>
      </tr>
      <tr>
        <th>Argument</th>
        <td>{Argument}</td>
      </tr>
      <tr>
        <th>Datetime</th>
        <td>{Datetime}</td>
      </tr>
      <tr>
        <th>TxID</th>
        <td>{TxID}</td>
      </tr>
      </tbody>
    </table>
  </li>
</script>

<script id="chListTemplate" type="x-template">
  <li data-name="{channelName}"><a href="#" class="_channelList"> {channelName}</a></li>
</script>

<script id="noDataTemplate" type="x-template">
  <li class="txt_no_data">
    <p>No data available</p>
    <span class="fas fa-database"></span>
  </li>
</script>

</body>
</html>


